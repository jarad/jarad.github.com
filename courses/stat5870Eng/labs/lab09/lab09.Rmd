---
title: "Lab09 - Multiple Regression in R"
author: "Jarad Niemi"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
---


[![](../rcode_button.png){fig-alt="R Code Button" fig-align="left" width=20%}](lab09.R)


```{r metadata, include=FALSE}
# Author: Jarad Niemi
# Date:   2024-11-07
# Purpose: This lab intends to introduce you to the syntax used in R to create
#          different multiple regression models.
#-------------------------------------------------------------------------------

```

Make sure the following 
packages are installed:

- GGally
- ggResidpanel

You can use the following code to perform the installation:

```{r, eval=FALSE}
install.packages("GGally") # ggpairs()
install.packages("ggResidpanel") # resid_panel() and resid_xpanel()
```

Now load packages

```{r packages}
library("tidyverse"); theme_set(theme_bw())
library("Sleuth3")
library("GGally")
library("ggResidpanel")
```

Before we begin, let's create a function to look at diagnostic plots from the 
ggResidpanel package. 
Here is my prefered set of plots.

```{r my-diag}
# My diagnostic plots
my_diag <- function(m) {
  resid_panel(m, 
              plots = c("qq",     # qqplot for normality 
                        "resid",  # resid v fitted for linearity and constant variance
                        "cookd",  # Cook's Distance for influential observations
                        "index"), # resid v row number for indepence
              smoother = TRUE,    # add smoothing lines to resid and index plots
              qqbands = TRUE)     # add bands for qq plot
}
```

We will only use these plots when we want to. 


## Higher order terms

Consider the `case1001` data set.

```{r case1001-data0plot}
ggplot(case1001, aes(Height, Distance)) +
  geom_point()
```

There are a number of ways to run the cubic model.

```{r case1001-tmp}
# First create the variables yourself
case1001_tmp <- case1001 |>
  mutate(Height2 = Height * Height,
         Height3 = Height * Height2)

# Then run the regression
m1 <- lm(Distance ~ Height + Height2 + Height3, data = case1001_tmp)
```

I don't prefer this method because 

- it clutters your `data.frame` with unnecessary columns and
- it makes prediction harder

```{r case1001-prediction-hard}
new <- data.frame(Height = 500) |>
  mutate(Height2 = Height * Height,  # Need to manually create the
         Height3 = Height * Height2) # quadratic and cubic terms

predict(m1, new)
```

An alternative approach is to use a formula to construct the higher order terms.
e.g.

```{r case1001-models}
m2 <- lm(Distance ~ Height + I(Height^2) + I(Height^3), data = case1001) # or
m3 <- lm(Distance ~ poly(Height, 3, raw = TRUE),        data = case1001)
```

Now, your original `data.frame` is unchanged and your new `data.frame` is 
simpler.

```{r case1001-predict-easy}
new <- data.frame(Height = 500)
predict(m2, newdata = new) # or
predict(m3, newdata = new)
```


## Additional explanatory variables

Run the following code to construct the longnosedace data

```{r longnosedace-data}
# From http://www.biostathandbook.com/multipleregression.html
# Modified from http://rcompanion.org/rcompanion/e_05.html
Input = ("
stream                   count acreage  dO2   maxdepth  no3   so4     temp
BASIN_RUN                  13         2528    9.6  80        2.28  16.75   15.3
BEAR_BR                    12         3333    8.5  83        5.34   7.74   19.4
BEAR_CR                    54        19611    8.3  96        0.99  10.92   19.5
BEAVER_DAM_CR              19         3570    9.2  56        5.44  16.53   17
BEAVER_RUN                 37         1722    8.1  43        5.66   5.91   19.3
BENNETT_CR                  2          583    9.2  51        2.26   8.81   12.9
BIG_BR                     72         4790    9.4  91        4.1    5.65   16.7
BIG_ELK_CR                164        35971   10.2  81        3.2   17.53   13.8
BIG_PIPE_CR                18        25440    7.5  120       3.53   8.2    13.7
BLUE_LICK_RUN               1         2217    8.5  46        1.2   10.85   14.3
BROAD_RUN                  53         1971   11.9  56        3.25  11.12   22.2
BUFFALO_RUN                16        12620    8.3  37        0.61  18.87   16.8
BUSH_CR                    32        19046    8.3  120       2.93  11.31   18
CABIN_JOHN_CR              21         8612    8.2  103       1.57  16.09   15
CARROLL_BR                 23         3896   10.4  105       2.77  12.79   18.4
COLLIER_RUN                18         6298    8.6  42        0.26  17.63   18.2
CONOWINGO_CR              112        27350    8.5  65        6.95  14.94   24.1
DEAD_RUN                   25         4145    8.7  51        0.34  44.93   23
DEEP_RUN                    5         1175    7.7  57        1.3   21.68   21.8
DEER_CR                    26         8297    9.9  60        5.26  6.36    19.1
DORSEY_RUN                  8         7814    6.8  160       0.44  20.24   22.6
FALLS_RUN                  15         1745    9.4  48        2.19  10.27   14.3
FISHING_CR                 11         5046    7.6  109       0.73   7.1    19
FLINTSTONE_CR              11        18943    9.2  50        0.25  14.21   18.5
GREAT_SENECA_CR            87         8624    8.6  78        3.37   7.51   21.3
GREENE_BR                  33         2225    9.1  41        2.3    9.72   20.5
GUNPOWDER_FALLS            22        12659    9.7  65        3.3    5.98   18
HAINES_BR                  98         1967    8.6  50        7.71  26.44   16.8
HAWLINGS_R                  1         1172    8.3  73        2.62   4.64   20.5
HAY_MEADOW_BR               5          639    9.5  26        3.53   4.46   20.1
HERRINGTON_RUN              1         7056    6.4  60        0.25   9.82   24.5
HOLLANDS_BR                38         1934   10.5  85        2.34  11.44   12
ISRAEL_CR                  30         6260    9.5  133       2.41  13.77   21
LIBERTY_RES                12          424    8.3  62        3.49   5.82   20.2
LITTLE_ANTIETAM_CR         24         3488    9.3  44        2.11  13.37   24
LITTLE_BEAR_CR              6         3330    9.1  67        0.81   8.16   14.9
LITTLE_CONOCOCHEAGUE_CR    15         2227    6.8  54        0.33   7.6    24
LITTLE_DEER_CR             38         8115    9.6  110       3.4    9.22   20.5
LITTLE_FALLS               84         1600   10.2  56        3.54   5.69   19.5
LITTLE_GUNPOWDER_R          3        15305    9.7  85        2.6    6.96   17.5
LITTLE_HUNTING_CR          18         7121    9.5  58        0.51   7.41   16
LITTLE_PAINT_BR            63         5794    9.4  34        1.19  12.27   17.5
MAINSTEM_PATUXENT_R       239         8636    8.4  150       3.31   5.95   18.1
MEADOW_BR                 234         4803    8.5  93        5.01  10.98   24.3
MILL_CR                     6         1097    8.3  53        1.71  15.77   13.1
MORGAN_RUN                 76         9765    9.3  130       4.38   5.74   16.9
MUDDY_BR                   25         4266    8.9  68        2.05  12.77   17
MUDLICK_RUN                 8         1507    7.4  51        0.84  16.3    21
NORTH_BR                   23         3836    8.3  121       1.32   7.36   18.5
NORTH_BR_CASSELMAN_R       16        17419    7.4  48        0.29   2.5    18
NORTHWEST_BR                6         8735    8.2  63        1.56  13.22   20.8
NORTHWEST_BR_ANACOSTIA_R  100        22550    8.4  107       1.41  14.45   23
OWENS_CR                   80         9961    8.6  79        1.02   9.07   21.8
PATAPSCO_R                 28         4706    8.9  61        4.06   9.9    19.7
PINEY_BR                   48         4011    8.3  52        4.7    5.38   18.9
PINEY_CR                   18         6949    9.3  100       4.57  17.84   18.6
PINEY_RUN                  36        11405    9.2  70        2.17  10.17   23.6
PRETTYBOY_BR               19          904    9.8  39        6.81   9.2    19.2
RED_RUN                    32         3332    8.4  73        2.09   5.5    17.7
ROCK_CR                     3          575    6.8  33        2.47   7.61   18
SAVAGE_R                  106        29708    7.7  73        0.63  12.28   21.4
SECOND_MINE_BR             62         2511   10.2  60        4.17  10.75   17.7
SENECA_CR                  23        18422    9.9  45        1.58   8.37   20.1
SOUTH_BR_CASSELMAN_R        2         6311    7.6  46        0.64  21.16   18.5
SOUTH_BR_PATAPSCO          26         1450    7.9  60        2.96   8.84   18.6
SOUTH_FORK_LINGANORE_CR    20         4106   10.0  96        2.62   5.45   15.4
TUSCARORA_CR               38        10274    9.3  90        5.45  24.76   15
WATTS_BR                   19          510    6.7  82        5.25  14.19   26.5
")

longnosedace = read.table(textConnection(Input),header=TRUE)
```

Take a quick look at the data

```{r longnosedace-pairs}
head(longnosedace)
summary(longnosedace)

ggpairs(longnosedace |> select(-stream),
        progress = interactive()) 
```

Adding additional explanatory variables is accomplished by separating the 
explanatory variables by `+`.

```{r longnosedace-no3-maxdepth}
# Although I am demonstrating sqrt() here, I almost always use log() instead
m <- lm(sqrt(count) ~ no3 + maxdepth, data = longnosedace)
summary(m)
```

You can run a regression with all variables using `.`

```{r longnosedace-lm-all}
m <- lm(sqrt(count) ~ ., data = longnosedace)
summary(m)
```

But you need to make sure you want to include all the variables. 
In this case, we probably wanted to exclude the `stream` variable 

```{r longnosedace-lm-all-relevant}
# Remove stream via the data argument
m <- lm(sqrt(count) ~ ., data = longnosedace |> select(-stream))
summary(m)
```

or

```{r longnose-dace-minus-stream}
# Remove stream in the formula
m <- lm(sqrt(count) ~ .-stream, data = longnosedace)
summary(m)
```

You can also use this technique to eliminate the intercept and perform
"regression through the origin". 

```{r longnosedace-regression-through-the-origin}
# Sometimes this seems appealing, but I've never used it in practice
m <- lm(sqrt(count) ~ no3 + acreage - 1, data = longnosedace)
summary(m)
```

This is not a common model but there may be a time when you want to force
the intercept to be 0. 

## Interactions

Interactions can be added to a model by using a colon (:) between two 
explanatory variables, e.g.

```{r longnosedace-interaction-explicit}
# Add an interaction explicitly
m1 <- lm(sqrt(count) ~ no3 + maxdepth + no3:maxdepth, data = longnosedace)
summary(m1)
```

But because we have a convention of including main effects (lower order terms)
whenever an interaction (higher order term) is included in the model, 
R provides a convenient way of including both the main effects as well as 
the interaction by using an asterisk (*). 

```{r longnosedace-interaction-implicit}
# Add an interaction implicitly
m2 <- lm(sqrt(count) ~ no3 * maxdepth, data = longnosedace)
summary(m2)
```

Alternatively, you can use the caret symbol (^) and specifying what order 
interactions you want. 
For example `^2` will include all two-way interactions.

```{r longnosedace-all-two-way-interactions-1}
# Add all 2 way interactions (there is only 1 here)
m3 <- lm(sqrt(count) ~ (no3 + maxdepth)^2, data = longnosedace)
summary(m3)
```

If you want to include more terms, 
you have a couple of options, e.g. 

```{r longnosedace-all-two-way-interactions-3}
# main effects and two-way interactions
# using ()^2
m4 <- lm(sqrt(count) ~ (no3 + maxdepth + acreage)^2, data = longnosedace) 
summary(m4)

# main effects, two-way interactions, and three-way interaction
# using ()^3
m5 <- lm(sqrt(count) ~ (no3 + maxdepth + acreage)^3, data = longnosedace) 
summary(m5)

# main effects, two-way interactions, and three-way interaction
# using * 
m5 <- lm(sqrt(count) ~ no3 * maxdepth * acreage, data = longnosedace) 
summary(m5)
```

We can combine the `.` with this notation for higher order terms. 

```{r longnosedace-all-two-way-interactions-of-all-variables-except-stream}
# remove stream and then include all 2-way interactions
m <- lm(sqrt(count) ~ .^2, data = longnosedace |> select(-stream))
summary(m)
```


## Adding or removing variables

Another approach that might be useful is to construct a model and then add or 
remove variables from that model.

```{r longnosedace-lm-no3}
# Simply linear regression model
m <- lm(sqrt(count) ~ no3, data = longnosedace)
summary(m)

# Add acreage
mA <- update(m, ~ . + acreage)
summary(mA)

# Remove no3
mR <- update(mA, ~ . - no3)
summary(mR)
```



You can find out more information by looking at 

```{r formula-help, eval=FALSE}
?formula
```

## Activities

Practice these skills by taking a look at the data sets in the `Sleuth3` 
package.

```{r sleuth3, eval=FALSE}
help(package="Sleuth3")
```

The data sets are organized by 

1. textbook usage ([case] study or [ex]ample)
2. chapter, e.g. case0701 is chapter 7
3. number, e.g. case0701 is number 1.

The [Statistical Sleuth](http://www.statisticalsleuth.com/) 3rd ed by Ramsey 
and Schafer begins discussing regression in Chapter 7 (although ANOVA is 
discussed in Chapter 5). 
Thus, data sets in Chapters 5 through 14 are relevant for exploration.
When you get a new data set ask yourself these questions in this order

1. What is the response variable?
2. How many explanatory variables are there?
3. Is the explanatory variable continuous or categorical? 
4. How many levels does each categorical explanatory variable have?

